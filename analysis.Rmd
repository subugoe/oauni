---
title: "Analysis of German publication output"
author: "Anne Hobert"
date: "3/6/2020"
output:
  word_document:
    fig_caption: yes
  github_document:
urlcolor: blue
---

```{r, echo = FALSE, message = FALSE, warning = FALSE}
knitr::opts_chunk$set(
  comment = "#>",
  collapse = TRUE,
  warning = FALSE,
  message = FALSE,
  echo = FALSE,
  fig.width = 6,
  fig.asp = 0.618,
  out.width = "90%",
  fig.align = "center",
  dpi = 300
)
```

```{r}
library(tidyverse)
#library(urltools)
library(cowplot)
library(colorblindr)
library(scales)
library(viridis)
```

## Data

In this document we describe the analysis of our sample of publications from German research institutions. We work with the dataset `pubs_cat` generated in [data_gathering.Rmd](data_gathering.Rmd).

```{r}
pubs_cat <- readr::read_csv("data/pubs_cat.csv", col_types = "dccdcclc")
```


## Investigation of research questions

The goal is to answer the three research questions 

1) Has the OA fraction of the publication output of German universities and research institutions increased constantly over time?
2) Can we observe differences between the research sectors of the German science system? Are there obvious explanations for this (like different missions or subject profiles?
3) Which OA type is the most prevalent OA approach and can we identify different patterns of adoption to OA?

### OA fraction of the German publication output
 
 First, we look at how the overall OA share developed over time. The following figure displays the number of publications associated with one of the German research institutions we considered and highlights they part that is freely accessible online according to Unpaywall over the considered time period from 2010 until 2018.
 
```{r, fig.cap="Open access to journal articles from German research institutions according to Unpaywall. Blue area represents journal articles with at least one freely available full-text, grey area represents toll-access articles."}
pubs_all <- pubs_cat %>%
  mutate(
    oa_category = fct_relevel(
      factor(oa_category),
      "full_oa_journal",
      "other_oa_journal",
      "opendoar_inst",
      "opendoar_subject",
      "opendoar_other",
      "other_repo",
      "not_oa"
    )
  ) %>%
  mutate(oa_category = fct_collapse(
    oa_category,
    is_oa = c(
      "full_oa_journal",
      "other_oa_journal",
      "opendoar_inst",
      "opendoar_subject",
      "opendoar_other",
      "other_repo"
    ),
    not_oa = "not_oa"
  ))  %>%
  group_by(PUBYEAR) %>% 
  mutate(n_total_year = n_distinct(PK_ITEMS)) %>% 
  ungroup() %>% 
  group_by(PUBYEAR, oa_category, n_total_year) %>%
  summarise(number_of_articles = n_distinct(PK_ITEMS))
  ggplot(pubs_all, aes(x = PUBYEAR, y = number_of_articles)) +
  geom_area(aes(fill = fct_rev(oa_category), group = fct_rev(oa_category)),  alpha = 0.8, colour = "white") +
  scale_fill_manual(
    values = c("#cccccca0", "#56b4e9"),
    name = NULL,
    labels = c("Closed", "Open Access")
  ) +
  scale_y_continuous(
    labels = scales::number_format(big.mark = ","),
    expand = expansion(mult = c(0, 0.05)),
    breaks =  scales::extended_breaks()(0:110000)
    ) + 
  labs(x = "Publication Year", y = "Total Articles") +
#  theme_minimal_hgrid(12) +
  theme_minimal_hgrid() +
  theme(legend.position = "top",
          legend.justification = "right")
```

As can be seen, the total number of articles, as well as the part that is OA increases constantly over time. The number of articles that are not openly available, is quite stable with a slow increase from `r pubs_cat %>% filter(oa_category == "not_oa") %>% group_by(PUBYEAR) %>% summarise(n = n_distinct(PK_ITEMS)) %>% filter(PUBYEAR == 2010) %>% .$n` in 2010 to `r pubs_cat %>% filter(oa_category == "not_oa") %>% group_by(PUBYEAR) %>% summarise(n = n_distinct(PK_ITEMS)) %>% filter(PUBYEAR == 2013) %>% .$n` in 2013, and decreasing again continuously from that point onwards to `r pubs_cat %>% filter(oa_category == "not_oa") %>% group_by(PUBYEAR) %>% summarise(n = n_distinct(PK_ITEMS)) %>% filter(PUBYEAR == 2018) %>% .$n`  publications in 2018. Since the number of OA articles increases continuously from `r pubs_cat %>% filter(oa_category != "not_oa") %>% group_by(PUBYEAR) %>% summarise(n = n_distinct(PK_ITEMS)) %>% filter(PUBYEAR == 2010) %>% .$n` publications in 2010 to `r pubs_cat %>% filter(oa_category != "not_oa") %>% group_by(PUBYEAR) %>% summarise(n = n_distinct(PK_ITEMS)) %>% filter(PUBYEAR == 2018) %>% .$n` in 2018, the relative proportion of OA articles rises significantly from `r round(pubs_cat %>% filter(oa_category != "not_oa") %>% group_by(PUBYEAR) %>% summarise(n = n_distinct(PK_ITEMS)) %>% filter(PUBYEAR == 2010) %>% .$n/pubs_cat %>% group_by(PUBYEAR) %>% summarise(n = n_distinct(PK_ITEMS)) %>% filter(PUBYEAR == 2010) %>% .$n, 4)*100` % in 2010 to `r round(pubs_cat %>% filter(oa_category != "not_oa") %>% group_by(PUBYEAR) %>% summarise(n = n_distinct(PK_ITEMS)) %>% filter(PUBYEAR == 2018) %>% .$n/pubs_cat %>% group_by(PUBYEAR) %>% summarise(n = n_distinct(PK_ITEMS)) %>% filter(PUBYEAR == 2018) %>% .$n, 4)*100` % in 2018.

```{r,eval=FALSE}
pubs_cat %>% 
  mutate(oa_category = fct_relevel(factor(oa_category), "full_oa_journal", "other_oa_journal", "opendoar_inst", "opendoar_subject", "opendoar_other", "other_repo", "not_oa")) %>% 
  mutate(oa_category = fct_collapse(oa_category,
    is_oa = c("full_oa_journal", "other_oa_journal", "opendoar_inst", "opendoar_subject", "opendoar_other", "other_repo"),
    not_oa = "not_oa"
  ))  %>%
  group_by(PUBYEAR, oa_category) %>% 
  summarise(number_of_articles = n_distinct(PK_ITEMS)) %>%
#  mutate(oa_category = ifelse(oa_category == "not_oa", "Not OA", "OA")) %>% 
  pivot_wider(names_from = oa_category, values_from = number_of_articles) %>% 
  knitr::kable(
    col.names = c(
      "Publication Year",
      "OA",
      "Not OA"
    ),
    big.mark = ",",
    caption = "Number of articles that are openly accessible (OA) or not (Not OA) per year."
  )
```

### Differences between sectors

In order to investigate what role the different sectors play in OA publishing in Germany and how they contribute to the OA development/overall OA shares, we distplay the development over time of the number of OA articles for each sector in the following figure. Note that scales for the `y-axes` are not the same, since the total publication output varies significantly among sectors.

```{r, fig.asp=1, fig.cap="Open access to journal articles per sector according to Unpaywall. Blue area represents journal articles with at least one freely available full-text, grey area represents toll-access articles. Sectors are ordered by publication output with the highest output top left and lowest at the bottom. Note that scales for the `y-axes` are not the same, since the total publication output varies significantly among sectors."}
pubs_cat %>%
  mutate(
    oa_category = fct_relevel(
      factor(oa_category),
      "full_oa_journal",
      "other_oa_journal",
      "opendoar_inst",
      "opendoar_subject",
      "opendoar_other",
      "other_repo",
      "not_oa"
    )
  ) %>%
  mutate(oa_category = fct_collapse(
    oa_category,
    is_oa = c(
      "full_oa_journal",
      "other_oa_journal",
      "opendoar_inst",
      "opendoar_subject",
      "opendoar_other",
      "other_repo"
    ),
    not_oa = "not_oa"
  ))  %>%
  group_by(sector) %>%
  mutate(n_total = n_distinct(PK_ITEMS)) %>%
  ungroup() %>%
  group_by(sector, PUBYEAR, oa_category, n_total) %>%
  summarise(number_of_articles = n_distinct(PK_ITEMS)) %>%
  ggplot(aes(x = PUBYEAR, y = number_of_articles)) +
  geom_area(aes(fill = fct_rev(oa_category), group = fct_rev(oa_category)),  alpha = 0.8, colour = "white") +
  scale_fill_manual(
    values = c("#cccccca0", "#56b4e9"),
    name = NULL,
    labels = c("Closed", "Open Access")
  ) +
  facet_wrap( ~ fct_rev(fct_reorder(sector, n_total)), scales = "free", ncol = 2) +
  labs(x = "Publication Year", y = "Total Articles") +
  scale_y_continuous(
    labels = scales::number_format(big.mark = ","),
    expand = expansion(mult = c(0, 0.05)),
    breaks =  scales::extended_breaks()
    ) + 
  labs(x = "Publication Year", y = "Total Articles") +
  theme(legend.position = "top",
          legend.justification = "right") +
  theme_minimal_hgrid() +
  # bold facet names
  theme(strip.text = element_text(face="bold")) +
   theme(legend.position = "top",
          legend.justification = "right")
```

In order to investigate the variability of OA publishing within the sectors, we now go one level deeper and examine OA shares of individual institutions, grouped by the sector they belong to. We only include institututions with a publication output of at least 100 publications in the observed time period of 9 years. Of the `r pubs_cat %>% summarise(n = n_distinct(INST_NAME)) %>% .$n` institutions in total, `r pubs_cat %>% group_by(INST_NAME) %>% mutate(n_total = n_distinct(PK_ITEMS)) %>% ungroup() %>% filter(n_total >= 100) %>% summarise(n = n_distinct(INST_NAME)) %>% .$n` fulfill this condition. This means, that in the following institution specific analyses, `r pubs_cat %>% group_by(INST_NAME) %>% mutate(n_total = n_distinct(PK_ITEMS)) %>% ungroup() %>% filter(n_total < 100) %>% summarise(n = n_distinct(INST_NAME)) %>% .$n` insitutions, or `r pubs_cat %>% group_by(INST_NAME) %>% mutate(n_total = n_distinct(PK_ITEMS)) %>% ungroup() %>% filter(n_total < 100) %>% summarise(n = n_distinct(PK_ITEMS)) %>% .$n` articles are not considered. Of the remaining institutions, we first calculate the individual OA shares.

```{r}
oa_shares <- pubs_cat %>%
  mutate(oa_category = factor(
    oa_category,
    levels = c(
      "full_oa_journal",
      "other_oa_journal",
      "opendoar_inst",
      "opendoar_subject",
      "opendoar_other",
      "other_repo",
      "not_oa"
    )
  )) %>%
  mutate(oa_category = fct_collapse(
    oa_category,
    is_oa = c(
      "full_oa_journal",
      "other_oa_journal",
      "opendoar_inst",
      "opendoar_subject",
      "opendoar_other",
      "other_repo"
    ),
    not_oa = "not_oa"
  )) %>%
  group_by(INST_NAME) %>%
  mutate(n_total = n_distinct(PK_ITEMS)) %>%
  ungroup() %>%
  group_by(INST_NAME, oa_category, n_total) %>%
  summarise(n_cat = n_distinct(PK_ITEMS)) %>%
  pivot_wider(
    names_from = oa_category,
    values_from = n_cat,
    values_fill = list(n_cat = 0)
  ) %>%
  mutate(oa_share = is_oa / n_total) %>%
  rename(n_oa = is_oa, n_not_oa = not_oa) %>%
  ungroup()
```
The following figure displays scatterplots where the OA share of an institution over the whole time period is shown with respect to its publication output.

```{r, fig.asp=1, fig.cap="Open Access shares of research institutions in Germany with respect to their total publication output grouped by the sector they belong to. Only institutions with at least 100 publications are shown. Blue points correspond to single insitutions, gray lines are obained by linear regression within the sector, gray areas are pointwise symmetric 95% t-distribution confidence bands. Scales of the x-axes vary across subplots in order to adapt to the different publication volumes. Dashed lines show the median value per sector for the OA share (red) and the total number of publications (orange)."}
oa_share_by_sector <- pubs_cat %>%
  mutate(oa_category = factor(
    oa_category,
    levels = c(
      "full_oa_journal",
      "other_oa_journal",
      "opendoar_inst",
      "opendoar_subject",
      "opendoar_other",
      "other_repo",
      "not_oa"
    )
  )) %>%
  mutate(oa_category = fct_collapse(
    oa_category,
    journal_oa = c("full_oa_journal", "other_oa_journal"),
    repo_oa = c(
      "opendoar_inst",
      "opendoar_subject",
      "opendoar_other",
      "other_repo"
    ),
    not_oa = "not_oa"
  )) %>%
  group_by(sector) %>%
  mutate(n_total_sec = n_distinct(PK_ITEMS)) %>%
  ungroup() %>%
  left_join(oa_shares, by = 'INST_NAME') %>%
  filter(n_total >= 100) %>%
  group_by(sector, INST_NAME, n_total, oa_share, n_total_sec) %>%
  summarise() 
oa_share_by_sector_stats <- oa_share_by_sector %>% 
  ungroup() %>% 
  group_by(sector) %>% 
  summarise(mean_oa_share = mean(oa_share), 
            median_oa_share = median(oa_share),
            mean_pub_volume = mean(n_total),
            median_pub_volume = median(n_total)
            )
left_join(oa_share_by_sector, oa_share_by_sector_stats, by = "sector") %>%
ggplot(aes(x = n_total, y = oa_share)) +
  geom_point(color = "#56b4e9", alpha = .7)  +
  scale_x_log10() +
  scale_y_continuous(labels = scales::percent_format(accuracy = 5L),
                     expand = expansion(mult = c(0, 0.05)),
                     limits = c(0,1)) +
  geom_smooth(color = "#999999a0", method = "lm") +
  facet_wrap(~ fct_rev(fct_reorder(sector, n_total_sec)), ncol = 2, scales = "free_x") +
  geom_hline(aes(yintercept = median_oa_share),
             colour = "#d55e00", linetype ="dashed", size = 1) +
  geom_vline(aes(xintercept = median_pub_volume),
             colour = "#E69F00", linetype ="dashed", size = 1) +
  labs(x = "Total Articles (logarithmic scale)", y = "OA percentage") +
  theme_minimal_grid() +
  theme(legend.position = "none") +
  # bold facet labels
  theme(strip.text = element_text(face = "bold"))
```
The most striking observations from this figure are the high OA shares of most of the Max-Planck and Helmholtz institutes and the very low OA fractions of almost all of the state and federal institutes as well as the ones from the Fraunhofer Society. Universities and Leibniz-Society have many institutes with OA shares close to one half. We can further see very well that the universities have by far the largest publication volumes, followed by the Helmholtz-Society. The linear trend of higher publication volume implying higher OA shares is most distinctive for the university sector (narrowest confidence bands). 

The following box plot quantifies the observations regarding the variability of OA shares within sectors made before.

```{r, fig.cap="OA shares of German research institutions per sector. The color of the boxes groups sectors into universities with a typically high total journal publication output, research-oriented institutes with a medium journal publication output and practise oriented institutions with a comparatively low journal publication output. Gray points display the OA shares for individual institutions."}
pubs_cat %>%
  group_by(sector) %>%
  mutate(
    n_sector = n_distinct(PK_ITEMS),
    sector_cat = case_when(
      n_sector > 500000 ~ 'high_n_pubs',
      n_sector > 50000 ~ 'middle_n_pubs',
      TRUE ~ 'low_n_pubs'
    )
  ) %>%
  mutate(sector_cat = factor(
    sector_cat,
    levels = c("high_n_pubs", "middle_n_pubs", "low_n_pubs")
  )) %>%
  ungroup() %>%
  left_join(oa_shares, by = 'INST_NAME') %>%
  filter(n_total > 100) %>% 
  group_by(INST_NAME, sector, oa_share, sector_cat, n_sector) %>%
  summarise() %>%
  ggplot(aes(x = reorder(sector, n_sector), y = oa_share)) +
  geom_boxplot(aes(color = sector_cat), varwidth = FALSE, size = 1) +
  geom_jitter(alpha = 0.1) +
  scale_y_continuous(labels = scales::percent_format(accuracy = 5L),
                     expand = expansion(mult = c(0, 0.05))) +
  coord_flip()  +
  scale_color_manual(
    values = c("#f68f46ff", "#a65c85ff", "#253582ff"),
    labels = c("Universities", "Research-oriented", "Practise-oriented")
  ) +
  # scale_color_viridis(
  #   end = 0.8,
  #   labels = c("Universities", "Research-oriented", "Practise-oriented"),
  #   discrete = TRUE,
  #   direction = -1,
  #   option = "plasma"
  # ) +
  labs(
    x = "",
    y = "OA percentage",
    color = ""
  )  +
  theme_minimal_vgrid()
```



### Prevalences of OA categories

As mentioned in the previous chapters, there are several ways of providing open access to scientific journal articles. In this section, we want to investigate the prevalence of the most widespread OA routes: Green OA and Gold OA. We further distinguish these two main categories as described in the methodology section (see Table 1) according to whether the journal is fully OA (Gold OA), and into deposition on disciplinary, institutional, or OpenDOAR-listed repositories (Green OA). Note that, as mentioned before, the OA categories are not exclusive, that is, an article might be counted for several categories and numbers not necessarily sum up to the total number of articles published. As a preliminary step, we therefore illustrate the most common combinations of OA categories in our dataset.

```{r}
# library(UpSetR)
# cat_overlap <- pubs_cat %>% 
#   filter(oa_category != "not_oa") %>% 
#   select(PK_ITEMS, oa_category) %>% 
#   distinct() %>% 
#   arrange(PK_ITEMS, oa_category) %>% 
#   aggregate(oa_category ~ PK_ITEMS, data = ., paste, collapse = "&") %>% 
#   group_by(oa_category) %>% 
#   summarise(n = n_distinct(PK_ITEMS))
# readr::write_csv(cat_overlap, "data/overlap_oa_categories.csv")
# # list with counts
# cat_overlap_list <- as.list(cat_overlap$n)
# # categories as list names
# names(cat_overlap_list) <- cat_overlap$oa_category
# # convert to vector
# cat_overlap_upset_expr <- unlist(cat_overlap_list)
# upset(fromExpression(cat_overlap_upset_expr), sets = rev(c("full_oa_journal", "other_oa_journal", "opendoar_inst", "opendoar_subject", "opendoar_other", "other_repo")), keep.order = TRUE, nintersects = 20, order.by = "freq", show.numbers = FALSE, set_size.angles = 25)
```


Keeping in mind that our categories are non-exclusive, as just shown, we now visualise the number of articles per category on the national level, that is, not differentiated by sector.

```{r, fig.cap="Development of the total number of journal articles over time per OA category (as per schema in Table 1). Categories are non-exclusive, that is some articles may be counted for a journal and a repository category. Colors correspond to the OA category, linetypes to whether a publication is not OA (dotted), or is available through a repository (dashed) or a publisher (solid)."}
# n_cat <- pubs_cat %>% 
#   group_by(PUBYEAR, oa_category) %>% 
#   summarise(n = n_distinct(PK_ITEMS))%>%
#   ungroup() %>% 
#   mutate(PUBYEAR = lubridate::ymd(paste0(PUBYEAR, "-01-01")))
pubs_cat %>%
  group_by(PUBYEAR, oa_category) %>%
  summarise(number_of_articles = n_distinct(PK_ITEMS)) %>%
  mutate(
    oa_category = fct_relevel(
      factor(oa_category),
      "full_oa_journal",
      "other_oa_journal",
      "opendoar_inst",
      "opendoar_subject",
      "opendoar_other",
      "other_repo",
      "not_oa"
    )
  ) %>%
  mutate(oa_host = fct_collapse(
    oa_category,
    `Publisher OA` = c("full_oa_journal", "other_oa_journal"),
    `Repository OA` = c(
      "opendoar_inst",
      "opendoar_subject",
      "opendoar_other",
      "other_repo"
    ),
    `Closed` = "not_oa"
  )) %>%
  ungroup() %>%
  mutate(PUBYEAR = lubridate::ymd(paste0(PUBYEAR, "-01-01"))) %>%
  filter(oa_host != "Closed") %>%
  ggplot(aes(x = PUBYEAR, y = number_of_articles, group = oa_category)) +
  #    geom_line(aes(color = oa_category, linetype = oa_category), size = 0.7) +
  geom_line(aes(color = oa_category), size = 0.9) +
  scale_color_OkabeIto(name = "OA Category", order = c(4, 1, 2, 3, 5, 7, 6)) +
 # scale_linetype_manual(
  #  name = "OA Host type",
  #  values = c(1, 2, 3),
  #  labels = c("OA (publisher)", "OA (repository)", " Not OA")
  # ) +
  gghighlight::gghighlight(label_params = list(alpha = 0.8, force = 10, direction = "y", hjust = 1, segment.color = NA)) +
#  gghighlight::gghighlight(use_direct_label = FALSE) +
#  geom_label(aes(x = lubridate::ymd("2018-01-01"), y = c(22000, 15000, 15000, 35000, 2000, 10000), label = oa_category, color = oa_category)) +
  geom_area(data = filter(pubs_all, oa_category == "is_oa"), aes(lubridate::ymd(paste0(PUBYEAR, "-01-01")), number_of_articles), fill = "#cccccca0", color = "white", alpha = 0.2) +
  facet_wrap(~ oa_host) +
  labs(x = "Publication Year", y = "Total Articles") +
  theme_minimal_hgrid() +
  scale_x_date(date_labels = "%y") +
  scale_y_continuous(
    labels = scales::number_format(big.mark = ","),
    expand = expansion(mult = c(0, 0.05)),
    breaks =  scales::extended_breaks(n = 6),
    limits = c(0,60000)
    ) +
  theme(legend.position = "none") +
  # bold facet labels
  theme(strip.text = element_text(face = "bold"))
# +
#   ggsave("lineplot.png", width = 6, height = 4)
```
Observations:

- drop in other oa journal -> Delayed OA
- slight drop in other_repo -> more sources registered, published more in registered sources
- apart from this: all OA categories increase, not oa decreases
- most prevalent category: subject-specific repos, registered with OpenDOAR

relative numbers:

```{r, fig.cap="Development of the total number of journal articles over time per OA category (as per schema in Table 1). Categories are non-exclusive, that is some articles may be counted for a journal and a repository category. Colors correspond to the OA category, linetypes to whether a publication is not OA (dotted), or is available through a repository (dashed) or a publisher (solid)."}
# n_cat <- pubs_cat %>% 
#   group_by(PUBYEAR, oa_category) %>% 
#   summarise(n = n_distinct(PK_ITEMS))%>%
#   ungroup() %>% 
#   mutate(PUBYEAR = lubridate::ymd(paste0(PUBYEAR, "-01-01")))
pubs_cat %>%
  group_by(PUBYEAR) %>% 
  mutate(n_total = n_distinct(PK_ITEMS)) %>% 
  ungroup() %>% 
  group_by(PUBYEAR, oa_category, n_total) %>%
  summarise(number_of_articles = n_distinct(PK_ITEMS)) %>%
  ungroup() %>% 
  mutate(
    oa_category = fct_relevel(
      factor(oa_category),
      "full_oa_journal",
      "other_oa_journal",
      "opendoar_inst",
      "opendoar_subject",
      "opendoar_other",
      "other_repo",
      "not_oa"
    )
  ) %>%
  mutate(oa_host = fct_collapse(
    oa_category,
    `Publisher OA` = c("full_oa_journal", "other_oa_journal"),
    `Repository OA` = c(
      "opendoar_inst",
      "opendoar_subject",
      "opendoar_other",
      "other_repo"
    ),
    `Closed` = "not_oa"
  )) %>%
  ungroup() %>%
  mutate(PUBYEAR = lubridate::ymd(paste0(PUBYEAR, "-01-01")),
         prop = number_of_articles/n_total) %>%
  filter(oa_host != "Closed") %>%
  ggplot(aes(x = PUBYEAR, y = prop, group = oa_category)) +
  #    geom_line(aes(color = oa_category, linetype = oa_category), size = 0.7) +
  geom_line(aes(color = oa_category), size = 0.9) +
  scale_color_OkabeIto(name = "OA Category", order = c(4, 1, 2, 3, 5, 7, 6)) +
 # scale_linetype_manual(
  #  name = "OA Host type",
  #  values = c(1, 2, 3),
  #  labels = c("OA (publisher)", "OA (repository)", " Not OA")
  # ) +
  gghighlight::gghighlight(label_params = list(alpha = 0.8, force = 10, direction = "y", hjust = 1, segment.color = NA)) +
#  gghighlight::gghighlight(use_direct_label = FALSE) +
#  geom_label(aes(x = lubridate::ymd("2018-01-01"), y = c(22000, 15000, 15000, 35000, 2000, 10000), label = oa_category, color = oa_category)) +
  geom_area(data = filter(pubs_all, oa_category == "is_oa"), aes(lubridate::ymd(paste0(PUBYEAR, "-01-01")), number_of_articles/n_total_year), fill = "#cccccca0", color = "white", alpha = 0.2) +
  scale_y_continuous(labels = scales::percent_format(accuracy = 5L)) +
  facet_wrap(~ oa_host) +
  labs(x = "Publication Year", y = "Total Articles") +
  theme_minimal_hgrid() +
  scale_x_date(date_labels = "%y") +
  theme(legend.position = "none") +
  # bold facet labels
  theme(strip.text = element_text(face = "bold")) +
  ggsave("lineplot_rel.png", width = 6, height = 4)
```

Again, we go one step further and look at sector specific OA proportions.

```{r, fig.asp=1, fig.cap="OA shares per category and sector. The relationship between OA shares of individual OA categories (as per schema in Table 1) and overall OA share is shown. Point sizes correspond to total publication output. Coloring is according to sector."}
pubs_cat %>%
  mutate(oa_category = factor(
    oa_category,
    levels = c(
      "full_oa_journal",
      "other_oa_journal",
      "opendoar_inst",
      "opendoar_subject",
      "opendoar_other",
      "other_repo",
      "not_oa"
    )
  )) %>%
  group_by(sector) %>%
  mutate(n_total = n_distinct(PK_ITEMS)) %>%
  ungroup() %>%
  group_by(sector, oa_category, n_total) %>%
  mutate(n_cat = n_distinct(PK_ITEMS),
         share_cat = n_cat / n_total) %>%
  ungroup() %>%
  group_by(sector, oa_category, n_total, share_cat) %>%
  summarise() %>%
  pivot_wider(
    names_from = oa_category,
    values_from = share_cat,
    values_fill = list(share_cat = 0)
  ) %>%
  pivot_longer(
    cols = c(
      "full_oa_journal",
      "other_oa_journal",
      "opendoar_inst",
      "opendoar_subject",
      "opendoar_other",
      "other_repo"
    ),
    names_to = "oa_route",
    values_to = "share"
  ) %>%
  mutate(oa_route = factor(
    oa_route,
    levels = c(
      "full_oa_journal",
      "other_oa_journal",
      "opendoar_inst",
      "opendoar_subject",
      "opendoar_other",
      "other_repo"
    )
  )) %>%
  ggplot(aes(x = (1 - not_oa), y = share)) +
  geom_point(aes(color = fct_rev(fct_reorder(sector, n_total)), size = n_total)) +
  scale_y_continuous(labels = scales::percent_format(accuracy = 5L), 
                     expand = expansion(mult = c(0.2, 0.2)),
                     breaks = c(0, 0.1, 0.2, 0.3, 0.4, 0.5)) +
  scale_x_continuous(labels = scales::percent_format(accuracy = 5L)) +
  scale_color_brewer(palette = "Set2",
                     direction = -1,
                     name = "Sectors"
                     ) +
  guides(size = "none") +
  scale_size_continuous(range = c(3, 10)) +
  # scale_size_manual(values = c(4:9),
  #                       name = "Sectors",
  #                       labels = c("740098" = "Hochschulen",
  #                                  "121223" = "Helmholtz-Gemeinschaft",
  #                                  "93701" = "Max-Plank-Gesellschaft",
  #                                  "56684" = "Leibniz-Gemeinschaft",
  #                                  "25092" = "Ressortforschung",
  #                                  "14505" = "Fraunhofer-Gemeinschaft")
  #                       ) +
  facet_wrap( ~ oa_route, ncol = 2) +
  labs(x = "Overall OA percentage", y = "OA percentage by type") +
  theme_minimal_grid() + 
  theme(strip.text = element_text(face="bold")) +
  theme(legend.position = "top", legend.justification = "right") +
  guides(color = guide_legend(nrow = 3, byrow = TRUE))
```

  
### Discussion

 - Upset plot of overlapping evidence categories to show influence of semantic scholar, webscraping.

In order to demonstrate the prevalence of evidence categories in Unpaywall, we load the original, non-categorized Unpaywall data:

```{r}
# upw_evidence <- readr::read_csv("data/upw_evidence.csv")
# upw_ev_cat <- upw_evidence %>% 
#   mutate(upw_matched = ifelse(is.na(upw_doi), FALSE, TRUE)) %>% 
#   filter(is_paratext == FALSE | is.na(is_paratext))
# rm(upw_evidence)
```

We now determine the evidence combinations for all matched DOIs and then calculate the frequency of each combination found.

```{r}
# upw_ev_cat <- upw_ev_cat %>% 
#   filter(upw_matched == TRUE) %>%
#   select(upw_doi, evidence) %>% 
#   distinct() %>% 
#   arrange(upw_doi, evidence) %>% 
#   aggregate(evidence ~ upw_doi, data = ., paste, collapse = "&")
# upw_ev_cat_n <- upw_ev_cat %>% 
#   group_by(evidence) %>% 
#   summarise(n = n_distinct(upw_doi))
# upw_ev_cat_n %>% 
#   arrange(desc(n))
# upw_ev_cat_n %>% 
#   readr::write_csv("data/upw_ev_cat.csv")
```
We now prepare the data for plotting with the UpSetR package and visualise the overlapping evidence categories.

```{r}
# library(UpSetR)
# # list with counts
# upw_ev_upset_list <- as.list(upw_ev_cat_n$n)
# # categories as list names
# names(upw_ev_upset_list) <- upw_ev_cat_n$evidence
# # convert to vector
# evidence_categories_upset_expr <- unlist(upw_ev_upset_list)
# upset(fromExpression(evidence_categories_upset_expr), nsets = 7, nintersects = 15, order.by = "freq", show.numbers = FALSE, set_size.angles = 25)

```


